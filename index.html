<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gentle Rest</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Georgia", serif;
        background: #d7e2e8;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        overflow: hidden;
      }

      /* Language Toggle in Corner */
      .language-toggle {
        position: fixed;
        top: 30px;
        right: 30px;
        font-size: 0.9em;
        color: #6b7c8a;
        cursor: pointer;
        transition: color 0.3s ease;
        z-index: 1000;
      }

      .language-toggle:hover {
        color: #4a5568;
      }

      /* Main Container */
      .scene {
        position: relative;
        width: 100%;
        max-width: 600px;
        height: 500px;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      /* Envelope - bigger */
      .envelope {
        position: relative;
        width: 520px;
        height: 320px;
        cursor: pointer;
        transition: transform 0.3s ease;
      }

      .envelope:hover {
        transform: scale(1.02);
      }

      .envelope-body {
        position: absolute;
        width: 100%;
        height: 100%;
        background: #f5f0e8;
        border: 2px solid #d4c5b0;
        border-radius: 3px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        z-index: 1;
      }

      /* Envelope Flap */
      .envelope-flap {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 50%;
        background: #ede5d8;
        border: 2px solid #d4c5b0;
        border-bottom: none;
        transform-origin: top center;
        transition: transform 0.8s ease;
        clip-path: polygon(0 0, 50% 60%, 100% 0);
        z-index: 10;
      }

      .envelope.opened .envelope-flap {
        transform: rotateX(180deg);
      }

      /* Wax Seal - Realistic with 3D pressed flower emboss */
      .wax-seal {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 75px;
        height: 75px;
        border-radius: 50%;
        z-index: 20;
        cursor: pointer;
        transition: all 0.3s ease;
        
        /* Realistic wax gradient - lighter at edges, darker in center */
        background: radial-gradient(
          circle at 35% 30%,
          #e87171 0%,
          #d65555 25%,
          #c94545 50%,
          #a83232 75%,
          #8b2525 100%
        );
        
        /* Multiple shadows for 3D depth */
        box-shadow: 
          /* Outer drop shadow */
          0 5px 12px rgba(100, 30, 30, 0.5),
          /* Inner pressed shadow (top) */
          inset 0 -3px 6px rgba(0, 0, 0, 0.35),
          /* Inner highlight (bottom) */
          inset 0 3px 4px rgba(255, 255, 255, 0.2),
          /* Subtle outer glow */
          0 0 25px rgba(201, 69, 69, 0.25);
        
        /* Subtle texture overlay */
        background-image: 
          radial-gradient(
            circle at 35% 30%,
            #e87171 0%,
            #d65555 25%,
            #c94545 50%,
            #a83232 75%,
            #8b2525 100%
          ),
          /* Fine texture pattern */
          repeating-radial-gradient(
            circle at 50% 50%,
            transparent 0,
            transparent 1.5px,
            rgba(0, 0, 0, 0.04) 1.5px,
            rgba(0, 0, 0, 0.04) 3px
          );
      }

      .wax-seal:hover {
        transform: translate(-50%, -50%) scale(1.08);
        box-shadow: 
          0 7px 16px rgba(100, 30, 30, 0.6),
          inset 0 -3px 6px rgba(0, 0, 0, 0.35),
          inset 0 3px 4px rgba(255, 255, 255, 0.2),
          0 0 30px rgba(201, 69, 69, 0.35);
      }

      /* Flower center - pressed down emboss effect */
      .wax-seal::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 18px;
        height: 18px;
        background: radial-gradient(
          circle,
          rgba(0, 0, 0, 0.3) 0%,
          rgba(0, 0, 0, 0.15) 50%,
          transparent 100%
        );
        border-radius: 50%;
        /* Pressed inward effect */
        box-shadow: 
          inset 0 2px 3px rgba(0, 0, 0, 0.5),
          inset 0 -1px 2px rgba(255, 100, 100, 0.2),
          0 1px 1px rgba(255, 255, 255, 0.1);
      }

      /* Flower petals - carved/embossed pattern */
      .wax-seal::after {
        content: '✿';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        /* Dark shadow for pressed-in look */
        color: rgba(0, 0, 0, 0.3);
        font-size: 46px;
        /* Embossed shadow effect */
        text-shadow: 
          /* Dark pressed shadow */
          0 2px 1px rgba(0, 0, 0, 0.3),
          /* Light highlight on opposite side */
          0 -1px 0 rgba(255, 255, 255, 0.15),
          /* Subtle glow */
          0 0 3px rgba(0, 0, 0, 0.2);
        z-index: 1;
      }

      .envelope.opened .wax-seal {
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.5s ease;
      }

      /* Letter Inside */
      .letter {
        position: absolute;
        top: 4%;
        left: 50%;
        transform: translate(-50%, 0);
        width: 92%;
        height: 280px;
        background: white;
        border: 1px solid #e8e8e8;
        border-radius: 3px;
        padding: 20px 30px;
        opacity: 0;
        pointer-events: none;
        transition: none;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        z-index: 50;
        cursor: pointer;

        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        overflow: hidden;
      }

      .envelope.opened .letter {
        opacity: 1;
        pointer-events: auto;
        animation: popUpDown 1.4s ease-in-out forwards;
      }

      @keyframes popUpDown {
        0% {
          top: 4%;
          transform: translate(-50%, 0);
        }
        50% {
          top: -30%;
          transform: translate(-50%, 0);
        }
        100% {
          top: 4%;
          transform: translate(-50%, 0);
        }
      }

      /* Canvas glitter overlay - NOW SIMPLE CSS SPARKLES */
      .sparkles {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 0;
        opacity: 1;
        transition: opacity 0.5s ease;
      }

      .sparkles.hidden {
        opacity: 0;
      }

      .sparkle {
        position: absolute;
        font-size: 20px;
        opacity: 0;
        animation: twinkle 3s ease-in-out infinite;
        pointer-events: none;
      }

      /* Position sparkles around the letter */
      .sparkle:nth-child(1) {
        top: 15%;
        left: 10%;
        animation-delay: 0s;
      }

      .sparkle:nth-child(2) {
        top: 25%;
        right: 15%;
        animation-delay: 0.5s;
      }

      .sparkle:nth-child(3) {
        top: 40%;
        left: 20%;
        animation-delay: 1s;
      }

      .sparkle:nth-child(4) {
        top: 50%;
        right: 10%;
        animation-delay: 1.5s;
      }

      .sparkle:nth-child(5) {
        top: 65%;
        left: 15%;
        animation-delay: 2s;
      }

      .sparkle:nth-child(6) {
        top: 75%;
        right: 20%;
        animation-delay: 2.5s;
      }

      .sparkle:nth-child(7) {
        top: 20%;
        left: 50%;
        animation-delay: 0.7s;
      }

      .sparkle:nth-child(8) {
        top: 60%;
        left: 50%;
        animation-delay: 1.7s;
      }

      .sparkle:nth-child(9) {
        top: 35%;
        left: 80%;
        animation-delay: 1.2s;
      }

      .sparkle:nth-child(10) {
        top: 80%;
        left: 40%;
        animation-delay: 2.2s;
      }

      @keyframes twinkle {
        0%, 100% {
          opacity: 0;
          transform: scale(0.3) rotate(0deg);
        }
        50% {
          opacity: 1;
          transform: scale(1) rotate(180deg);
        }
      }

      .glitter-wrapper {
        position: relative;
        z-index: 1;
      }

      /* Message text */
      .message-text {
        font-size: 1.2em;
        line-height: 1.8;
        color: #2d3748;
        text-align: center;
        filter: blur(8px);
        opacity: 0.3;
        transition: all 0.6s ease;
        cursor: pointer;
        max-width: 420px;
      }

      .letter.revealed .message-text {
        filter: blur(0);
        opacity: 1;
      }

      .chinese {
        font-family: "Microsoft YaHei", "PingFang SC", "SimHei", sans-serif;
      }

      /* Instructions */
      .instructions {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        color: #8a9ba8;
        font-size: 0.9em;
        text-align: center;
        opacity: 0.7;
      }

      /* Title */
      h1 {
        position: fixed;
        top: 30px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 2.2em;
        color: #4a5568;
        font-weight: 300;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <h1>Gentle Rest</h1>

    <div class="language-toggle" id="languageToggle">切換中文</div>

    <div class="scene">
      <div class="envelope" id="envelope">
        <div class="envelope-body"></div>
        <div class="envelope-flap"></div>
        <div class="wax-seal" id="waxSeal"></div>

        <div class="letter" id="letter">
          <!-- Simple CSS sparkles instead of canvas -->
          <div class="sparkles" id="sparkles">
            <span class="sparkle">✨</span>
            <span class="sparkle">✨</span>
            <span class="sparkle">✨</span>
            <span class="sparkle">✨</span>
            <span class="sparkle">✨</span>
            <span class="sparkle">✨</span>
            <span class="sparkle">✨</span>
            <span class="sparkle">✨</span>
            <span class="sparkle">✨</span>
            <span class="sparkle">✨</span>
          </div>

          <!-- text on top -->
          <div class="glitter-wrapper">
            <p class="message-text" id="messageText">
              Click the wax seal to open
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="instructions" id="instructions">
      Click the wax seal to open your letter
    </div>

    <script>
      // ========= CONTEXT-FREE GRAMMAR =========
      class Grammar {
        constructor(rules) {
          this.rules = rules;
        }
        generate(symbol) {
          if (this.rules[symbol]) {
            const options = this.rules[symbol];
            const chosen =
              options[Math.floor(Math.random() * options.length)];
            return chosen
              .split(" ")
              .map((part) => {
                if (part.startsWith("<") && part.endsWith(">")) {
                  return this.generate(part);
                }
                return part;
              })
              .join(" ");
          }
          return symbol;
        }
        generateMessage() {
          return this.generate("<start>");
        }
      }

      const englishGrammar = new Grammar({
        "<start>": [
          "<validation> <permission>",
          "<validation> <rest>",
          "<permission> <rest>",
          "<validation> <permission> <rest>",
          "<you> <permission>",
          "<you> <rest>",
        ],
        "<validation>": [
          "You are doing enough today.",
          "Some days are harder than others.",
          "Your efforts matter, even when invisible.",
          "What you do is important.",
          "You are allowed to feel tired.",
          "Your feelings are valid.",
          "This work takes so much from you.",
        ],
        "<permission>": [
          "It is okay to rest.",
          "You can pause without guilt.",
          "Taking a break is not selfish.",
          "You are allowed to say no sometimes.",
          "Rest is not weakness.",
          "You deserve gentleness too.",
          "It is okay to ask for help.",
          "You do not have to be perfect.",
        ],
        "<rest>": [
          "Rest is part of the work.",
          "Small pauses count as care.",
          "Even five minutes matters.",
          "Rest helps you continue.",
          "Resting is not giving up.",
          "You can care for yourself while caring for others.",
          "Tomorrow you can try again.",
          "This moment of rest is yours.",
        ],
        "<you>": [
          "You are seen.",
          "You are not alone in this.",
          "You are doing your best.",
          "You matter.",
          "You are worthy of care.",
          "You are enough.",
        ],
      });

      const chineseGrammar = new Grammar({
        "<start>": [
          "<validation> <permission>",
          "<validation> <rest>",
          "<permission> <rest>",
          "<validation> <permission> <rest>",
          "<you> <permission>",
          "<you> <rest>",
        ],
        "<validation>": [
          "今天的你已經很努力了。",
          "有些日子就是比較難。",
          "你的付出很重要，即使沒有人看見。",
          "你做的事情很有意義。",
          "累了是正常的。",
          "你的感受是真實的。",
          "這份工作真的很辛苦。",
        ],
        "<permission>": [
          "休息是可以的。",
          "暫停不需要感到愧疚。",
          "休息不是自私。",
          "你可以偶爾說不。",
          "休息不是軟弱。",
          "你也值得被溫柔對待。",
          "尋求幫助是可以的。",
          "你不需要完美。",
        ],
        "<rest>": [
          "休息也是照顧的一部分。",
          "小小的暫停也算是照顧自己。",
          "就算只有五分鐘也很重要。",
          "休息讓你可以繼續下去。",
          "休息不是放棄。",
          "你可以在照顧別人的同時照顧自己。",
          "明天可以再試試看。",
          "這個休息的時刻屬於你。",
        ],
        "<you>": [
          "有人看見你的付出。",
          "你不是一個人。",
          "你已經盡力了。",
          "你很重要。",
          "你值得被照顧。",
          "你就是夠好的。",
        ],
      });

      let currentLanguage = "english";
      let currentGrammar = englishGrammar;
      let isEnvelopeOpened = false;
      
      // Store the structure of current message for translation
      let currentMessageParts = {
        validation: null,
        permission: null,
        rest: null,
        you: null
      };

      const envelope = document.getElementById("envelope");
      const waxSeal = document.getElementById("waxSeal");
      const letter = document.getElementById("letter");
      const messageText = document.getElementById("messageText");
      const languageToggle = document.getElementById("languageToggle");
      const instructions = document.getElementById("instructions");

      // Timer variables - runs silently in background
      let nextLetterTime = null;
      let countdownInterval = null;
      const FOUR_HOURS = 4 * 60 * 60 * 1000; // 4 hours in milliseconds

      // Initialize or get next letter time from localStorage
      function initializeTimer() {
        // If timer is already running, don't start again
        if (countdownInterval !== null) {
          return;
        }
        
        const stored = localStorage.getItem('nextLetterTime');
        if (stored) {
          nextLetterTime = parseInt(stored);
          // If time has passed, reset
          if (Date.now() >= nextLetterTime) {
            setNextLetterTime();
          }
        } else {
          setNextLetterTime();
        }
        startCountdown();
      }

      function setNextLetterTime() {
        nextLetterTime = Date.now() + FOUR_HOURS;
        localStorage.setItem('nextLetterTime', nextLetterTime.toString());
      }

      function updateCountdown() {
        const now = Date.now();
        const remaining = nextLetterTime - now;

        if (remaining <= 0) {
          // Time's up! Get new letter automatically
          automaticNewLetter();
        }
      }

      function startCountdown() {
        updateCountdown();
        countdownInterval = setInterval(updateCountdown, 1000);
      }

      function automaticNewLetter() {
        // Close current letter
        envelope.classList.remove("opened");
        isEnvelopeOpened = false;
        letter.classList.remove("revealed");

        // Show sparkles again
        document.getElementById('sparkles').classList.remove('hidden');

        // Reset instructions
        if (currentLanguage === "english") {
          instructions.textContent = "Click the wax seal to open your letter";
        } else {
          instructions.textContent = "點擊蠟封打開信件";
        }

        // Reset timer for next 4 hours
        setNextLetterTime();
        
        // Generate will happen when user opens envelope
      }

      function generateAndRememberMessage() {
        // Clear previous parts
        currentMessageParts = {
          validation: null,
          permission: null,
          rest: null,
          you: null
        };
        
        // Pick a random pattern
        const patterns = [
          ['validation', 'permission'],
          ['validation', 'rest'],
          ['permission', 'rest'],
          ['validation', 'permission', 'rest'],
          ['you', 'permission'],
          ['you', 'rest']
        ];
        const chosenPattern = patterns[Math.floor(Math.random() * patterns.length)];
        
        // For each part in the pattern, pick a random index and remember it
        const parts = [];
        for (let partType of chosenPattern) {
          const options = currentGrammar.rules['<' + partType + '>'];
          const index = Math.floor(Math.random() * options.length);
          currentMessageParts[partType] = index;
          parts.push(options[index]);
        }
        
        return parts.join(' ');
      }
      
      function translateCurrentMessage() {
        // Use the same indices to get the equivalent message in the other language
        const parts = [];
        
        for (let partType in currentMessageParts) {
          const index = currentMessageParts[partType];
          if (index !== null) {
            const options = currentGrammar.rules['<' + partType + '>'];
            parts.push(options[index]);
          }
        }
        
        return parts.join(' ');
      }
      
      function openEnvelope() {
        if (!isEnvelopeOpened) {
          envelope.classList.add("opened");
          isEnvelopeOpened = true;

          const message = generateAndRememberMessage();
          messageText.textContent = message;

          if (currentLanguage === "chinese") {
            messageText.classList.add("chinese");
          } else {
            messageText.classList.remove("chinese");
          }

          setTimeout(() => {
            instructions.textContent = "Click the text to reveal the message";
          }, 800);
        }
      }

      function toggleLanguage() {
        if (currentLanguage === "english") {
          currentLanguage = "chinese";
          currentGrammar = chineseGrammar;
          languageToggle.textContent = "Switch to English";
          instructions.textContent = "點擊蠟封打開信件";
        } else {
          currentLanguage = "english";
          currentGrammar = englishGrammar;
          languageToggle.textContent = "切換中文";
          instructions.textContent = "Click the wax seal to open your letter";
        }

        if (isEnvelopeOpened) {
          // Translate the SAME message, don't generate new one
          const message = translateCurrentMessage();
          messageText.textContent = message;

          if (currentLanguage === "chinese") {
            messageText.classList.add("chinese");
            instructions.textContent = "點擊文字顯示訊息";
          } else {
            messageText.classList.remove("chinese");
            instructions.textContent = "Click the text to reveal the message";
          }
        }
      }

      // Click on text reveals it AND stops glitter AND STARTS TIMER
      messageText.addEventListener("click", (e) => {
        e.stopPropagation();
        letter.classList.add("revealed");
        
        // Hide sparkles
        document.getElementById('sparkles').classList.add('hidden');
        
        // START THE 4-HOUR TIMER NOW!
        initializeTimer();
      });

      // Click on letter (but not text) only reveals, glitter continues
      letter.addEventListener("click", () => {
        letter.classList.add("revealed");
      });

      waxSeal.addEventListener("click", (e) => {
        e.stopPropagation();
        openEnvelope();
      });

      envelope.addEventListener("click", () => {
        if (!isEnvelopeOpened) {
          openEnvelope();
        }
      });

      languageToggle.addEventListener("click", toggleLanguage);

      // DON'T start timer on page load - only when user reveals the message
      // initializeTimer(); ← REMOVED
    </script>
  </body>
</html>
